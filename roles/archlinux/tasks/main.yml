---
- name: install reflector
  pacman: name=reflector state=present update_cache=yes
  sudo: yes

- name: generate pacman mirrorlist
  command: /usr/bin/reflector --country "United States" -l 200 -p http --sort rate --save /etc/pacman.d/mirrorlist
  sudo: yes

- name: update pacman package lists
  command: /usr/bin/pacman -Syy --noconfirm
  sudo: yes

- name: perform full upgrade
  command: /usr/bin/pacman -Su --noconfirm
  sudo: yes

- name: create normal_user
  user: name={{ normal_user }} createhome=yes group=users groups=wheel
  sudo: yes

- name: install utilities
  pacman: name={{ item }} state=present
  with_items:
    - curl
    - aria2
    - rsync
    - openssh
    - ntp
    - alsa-utils
  sudo: yes

- name: ensure network time is enabled
  service: name=ntpd state=started enabled=yes
  sudo: yes

- name: install fonts
  pacman: name={{ item }} state=present
  with_items:
    - ttf-dejavu
    - ttf-liberation
    - ttf-droid
    - ttf-inconsolata
    - adobe-source-code-pro-fonts
  sudo: yes

- name: install GUI
  pacman: name={{ item }} state=present
  with_items:
    - i3-wm
    - i3lock
    - i3status
    - dmenu
    - lightdm
    - lightdm-gtk3-greeter
    - lxappearance
    - arandr
    - elementary-icon-theme
    - xcursor-simpleandsoft
    - feh
  sudo: yes

- name: enable GUI on boot
  service: name=lightdm enabled=yes
  sudo: yes

- name: copy wallpaper image
  copy: src=korra_masseffect_wallpaper.png dest=/home/{{ normal_user }}/.wallpaper owner={{ normal_user }} group=users
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: template feh wallpaper script
  template: src=fehbg dest=/home/{{ normal_user }}/.fehbg owner={{ normal_user }} group=users
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: template i3 configuration
  template: src=i3/config dest=/home/{{ normal_user }}/.i3/config owner={{ normal_user }} group=users
  sudo: yes

- name: template i3status configuration
  template: src=i3/i3status dest=/home/{{ normal_user }}/.i3/i3status owner={{ normal_user }} group=users
  sudo: yes

- name: template .bashrc
  sudo: yes
  template: src=bashrc dest=/home/{{ normal_user}}/.bashrc owner={{ normal_user }} group=users

- name: template Xresources
  template: src=Xresources dest=/home/{{ normal_user }}/.Xresources owner={{ normal_user }} group=users
  sudo: yes

- name: install pulseaudio/alsa
  pacman: name={{ item }} state=present
  with_items:
    - alsa-utils
    - pulseaudio
    - pulseaudio-alsa
    - paprefs
    - pavucontrol

- name: install applications
  pacman: name={{ item }} state=present
  with_items:
    - xterm
    - pcmanfm
    - evince
    - gimp
    - viewnior
    - libreoffice-still
    - libreoffice-still-en-US
    - vlc
  sudo: yes

- name: install development enviornment
  sudo: yes
  pacman: name={{ item }} state=present
  with_items:
    # C/C++
    - base-devel
    - cmake
    - premake
    - gdb
    - valgrind
    # Python
    - python2
    - python2-pip
    - python
    - python-pip
    # Ruby
    - ruby
    # Java
    - jdk7-openjdk
    - openjdk7-doc
    - openjdk7-src
    - jdk8-openjdk
    - openjdk8-doc
    - openjdk8-src
    - apache-ant
    - maven
    # Version Control
    - git
    - subversion
    # Editors
    - gvim
    # Other tools
    - openssh
    - virtualbox
    - vagrant
    
- name: configure virtualbox kernel modules
  template: src=virtualbox.conf dest=/etc/modules-load.d/virtualbox.conf
  sudo: yes

- name: install vmware workstation dependencies
  pacman: name={{ item }}
  with_items:
    - fuse
    - gtkmm
    - linux-headers
  when: install_vmware|bool
  sudo: yes

- name: template vmware systemd service
  template: src=vmware.service dest=/etc/systemd/system/vmware.service
  sudo: yes

- name: install vagrant vbguest plugin
  command: "/usr/bin/vagrant plugin install vagrant-vbguest"
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: install vagrant vmware plugin (license required)
  command: /usr/bin/vagrant plugin install vagrant-vmware-workstation
  when: install_vmware|bool
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: configure git name
  command: "/usr/bin/git config --global user.name \"{{ user_real_name }}\""
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: configure git email
  command: "/usr/bin/git config --global user.email \"{{ user_email }}\""
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: install jekyll
  gem: name=jekyll state=present
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: create .vimrc directory
  file: path="/home/{{ normal_user }}/.vim/bundle" owner={{ normal_user }} group=users state=directory
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: install Vundle
  git: repo=https://github.com/gmarik/Vundle.vim.git dest="/home/{{ normal_user }}/.vim/bundle/Vundle.vim" accept_hostkey=yes
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: template .vimrc
  template: src=vimrc dest=/home/{{ normal_user }}/.vimrc owner={{ normal_user }} group=users
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: install Vundle plugins
  command: "/usr/bin/vim +PluginInstall +qall!"
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: install YouCompleteMe
  command: "/home/{{ normal_user }}/.vim/bundle/YouCompleteMe/install.sh"
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: ensure chromium is not installed
  pacman: name=chromium state=absent recurse=yes
  sudo: yes

- name: install AUR packages
  packer: name={{ item }}
  with_items:
    - packer # ensure packer is up to date
    - pacaur
    - powerline-fonts-git # used by vim-powerline
    - google-chrome
    - google-talkplugin
    - intellij-idea-ultimate-edition
    - sublime-text-dev
    - git-annex-bin
    - gtk-theme-boje # a nice dark theme
  sudo: yes
  sudo_user: "{{ normal_user }}"

- name: vmware instructions
  debug: msg="Install VMWare Workstation manually with '/usr/bin/sh <vmware installer> --eulas-agreed --required --console'"
  when: install_vmware|bool

